---
title: "RPE Control Sample"
output: html_notebook
---

## Load and process data

```{r}
input_dir <- "/Volumes/LACIE/RPE_scRNA/PUBLISHED/H9_RPE_YOUNG/outs/filtered_feature_bc_matrix/"
data <- Read10X(input_dir)
seurat_obj <- CreateSeuratObject(data, project = "RPE_scRNA")

# Add metadata
seurat_obj[["condition"]] <- "Control"

seurat_obj[["percent.mt"]] <- PercentageFeatureSet(seurat_obj, pattern = "^MT-")
seurat_obj[["percent.rb"]] <- PercentageFeatureSet(seurat_obj, pattern = "^RPS|^RPL")

```

## Extract metadata
```{r printMeta}
# Retrieve values to plot from the Seurat object
metadata <- seurat_obj@meta.data
print(metadata[1:10,])

```

## Quality control
This function will calculate mean absolute deviation thresholds - cells beyond
this point are usually outliers.

```{r madFunction}
calcThreshold <- function(x,
                          nmads = 3,
                          type = c("both", "lower", "upper"),
                          na.rm = FALSE){
    med_val <- stats::median(x, na.rm = na.rm)
    mad_val <- stats::mad(x, center = med_val, na.rm = na.rm)
    upper_limit <- med_val + nmads * mad_val
    lower_limit <- med_val - nmads * mad_val
    
    if (type == "lower"){
      return(lower_limit)
    } else if (type == "upper") {
      return(upper_limit)
    } else(
      return(list(lower_limit, upper_limit))
    )
}
```

We will use this function to generate thresholds for the number of UMIs per cell.
We have to convert the counts to log10 for this to work. We can then convert this
back afterwards.

```{r calcThreshold}
# Use function to calculate 3 MAD
nCount_lower_threshold <- calcThreshold(log10(metadata$nCount_RNA), nmads = 3, type = "lower")
nCount_upper_threshold <- calcThreshold(log10(metadata$nCount_RNA), nmads = 3, type = "upper")

# Convert to original value (unlog scale)
nCount_lower_threshold <- 10^(nCount_lower_threshold)
nCount_upper_threshold <- 10^(nCount_upper_threshold)
```

We can now review the cutoffs on our plots. I'm not a fan of Seurat's plots, so
I'll manually create some histograms and draw the thresholds as red lines.

```{r generatePlots}
# Generate plots
ncount_hist <- ggplot(metadata, aes(nCount_RNA)) + geom_histogram(bins = 100) +
  theme_bw() + geom_vline(xintercept = nCount_lower_threshold, color = "red") +
  geom_vline(xintercept = nCount_upper_threshold, color = "red") + ggtitle("RPE_scRNA - Control", subtitle = "Total UMIs per cell") +
  xlab("Total UMIs per cell") + ylab("Number of cells")

nfeature_hist <- ggplot(metadata, aes(nFeature_RNA)) + geom_histogram(bins = 100) +
  theme_bw() + geom_vline(xintercept = 220, color = "red") + ggtitle("RPE_scRNA - Control", subtitle = "Total genes per cell") + 
  xlab("Total genes per cell") + ylab("Number of cells")

mt_hist <- ggplot(metadata, aes(percent.mt)) + geom_histogram(bins = 100) +
  theme_bw() + geom_vline(xintercept = 25, color = "red") + ggtitle("RPE_scRNA - Control", subtitle = "Mitochondrial expression") +
  xlab("% Mitochondrial expression") + ylab("Number of cells")

rb_hist <- ggplot(metadata, aes(percent.rb)) + geom_histogram(bins = 100) +
  theme_bw() + geom_vline(xintercept = 60, color = "red") + ggtitle("RPE_scRNA - Control", subtitle = "Ribosomal expression") +
  xlab("% Ribosomal expression") + ylab("Number of cells")

```

```{r filterCells}
# Original number of cells
ncells1 <- ncol(seurat_obj)

# Filter poor quality cells from dataset
seurat_obj <- subset(seurat_obj, nCount_RNA > nCount_lower_threshold &
                       nCount_RNA < nCount_upper_threshold &
                       nFeature_RNA > 220 &
                       percent.mt < 25 &
                       percent.rb < 60)

ncells2 <- ncol(seurat_obj)
ncelldiff <- ncells1 - ncells2 
print(sprintf("%d cells filtered from dataset.", ncelldiff))
```

## Normalisation

```{r sctransform, echo = FALSE}
seurat_obj <- SCTransform(seurat_obj, 
                          vars.to.regress = c("percent.mt", "percent.rb"),
                          conserve.memory = TRUE, verbose = FALSE)
```

## Dimensionality reduction
```{r dimreduction}
# Principal component analysis
seurat_obj <- RunPCA(seurat_obj, verbose = FALSE)

# UMAP
seurat_obj <- RunUMAP(seurat_obj, dims = 1:30, umap.method = "uwot")
```

## Clustering

```{r clustering}
seurat_obj <- FindNeighbors(seurat_obj, dims = 1:30)
windows <- c(seq(0, 1, by = 0.1))

for (res in windows){
  seurat_obj <- FindClusters(seurat_obj, resolution = res, verbose = FALSE)
}
```

Perform a clustree.

```{r clustree}
library(clustree)
clustree_plot <- clustree(seurat_obj, prefix = "SCT_snn_res.")
clustree_plot
```

What is the right resolution? 1.2 looks good..

```{r check_res}
metadata <- FetchData(seurat_obj, vars = c("seurat_clusters", "SCT_snn_res.0.6"))
res_counts <- as.data.frame(table(metadata$SCT_snn_res.0.6))
res_hist <- ggplot(res_counts, aes(x = Var1, y = Freq)) + geom_bar(stat = "identity")
res_hist
```

